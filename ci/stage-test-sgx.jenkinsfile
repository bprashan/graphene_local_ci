stage('test-sgx') {
    env.no_cpu = sh(script:'nproc', returnStdout: true).trim()

    if(env.gcc_dump_machine != "x86_64-redhat-linux") 
    {          
        try{
            timeout(time: 5, unit: 'MINUTES') {
                sh '''
                    cd CI-Examples/python
                    cat python.manifest.template                    
                    make SGX=1 
                    cat python.manifest.sgx
                    gramine-sgx ./python scripts/helloworld.py
                    gramine-sgx ./python scripts/test-numpy.py
                    gramine-sgx ./python scripts/test-scipy.py
                    gramine-sgx ./python scripts/dummy-web-server.py 8005 & echo $! > server.PID
                    ../../Scripts/wait_for_server 60 127.0.0.1 8005
                    gramine-sgx ./python scripts/test-http.py 127.0.0.1 8005 > OUTPUT1
                    wget  http://127.0.0.1:8005/ -O OUTPUT2
                    echo >> OUTPUT2
                    diff OUTPUT1 OUTPUT2 | grep -q '^>' || echo "[ Success 2/4 ]"
                    kill "$(cat server.PID)"
                    cat OUTPUT1
                    cat OUTPUT2

                '''
            }
        } catch (Exception e){
            env.build_ok = false
            sh 'echo "Python Example Test Failed"'
        }
    }
}